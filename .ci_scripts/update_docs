#!/usr/bin/env bash

set -ex

git checkout -b new_site_content
# Generate html requires a GitHub token in order to query the available feedstocks.
conda env create -f ./.ci_scripts/environment.yml
conda activate conda-forge-docs

# rebuild elm
# uncomment to restore search
# npm install uglify-js --global
# ./elm-compile.xsh

# build docs into docs/; preserve old README file
mv docs/README docs-README
rm -rf docs/

cd src
make html
mv _build/html ../docs
rm -rf _build

cd ..
mv docs-README docs/README

# git diff

# Only commit the docs for commits on master.
# GITHUB_HEAD_REF is empty on forks
if [[ $GH_REF == ref/heads/master ]] && [[ "$GH_TOKEN" != "" ]]; then
    git add -A :/
    git commit -m "Re-ran make.py. [ci skip]" || true
    git remote add pushable https://${GH_TOKEN}@github.com/conda-forge/conda-forge.github.io.git/ > /dev/null

    # Update the remotes before pushing and check the status.
    # This should give us more info if the push will not be
    # a simple fast-forward push.
    git fetch --all 2> /dev/null
    git branch -u pushable/master
    git status
    git push pushable new_site_content:master 2> /dev/null
fi
